"use strict";(()=>{(function(){"use strict";let l=window.__vscodeApi||(window.__vscodeApi=acquireVsCodeApi()),oe=window.__accountsOverviewI18n||{},ke=window.__i18n||{},p=[],m=new Set,H="",C="all",T="overall",S="desc",h="grid",_=[],y={},z=!0,Q=null,V=0,j=[],se=h,q=null,Me=10,D="",$e=1,n={backBtn:document.getElementById("ao-back-btn"),announcementBtn:document.getElementById("announcement-btn"),settingsBtn:document.getElementById("settings-btn"),totalAccounts:document.getElementById("ao-total-accounts"),currentAccount:document.getElementById("ao-current-account"),searchInput:document.getElementById("ao-search-input"),filterSelect:document.getElementById("ao-filter-select"),sortSelect:document.getElementById("ao-sort-select"),sortDirectionBtn:document.getElementById("ao-sort-direction-btn"),viewListBtn:document.getElementById("ao-view-list"),viewGridBtn:document.getElementById("ao-view-grid"),refreshAllBtn:document.getElementById("ao-refresh-all-btn"),addBtn:document.getElementById("ao-add-btn"),importBtn:document.getElementById("ao-import-btn"),exportBtn:document.getElementById("ao-export-btn"),deleteSelectedBtn:document.getElementById("ao-delete-selected-btn"),selectAll:document.getElementById("ao-select-all"),accountsGrid:document.getElementById("ao-accounts-grid"),accountsTable:document.getElementById("ao-accounts-table"),accountsTbody:document.getElementById("ao-accounts-tbody"),emptyState:document.getElementById("ao-empty-state"),emptyMatch:document.getElementById("ao-empty-match"),loading:document.getElementById("ao-loading"),addFirstBtn:document.getElementById("ao-add-first-btn"),actionMessage:document.getElementById("ao-action-message"),actionMessageText:document.getElementById("ao-action-message-text"),actionMessageClose:document.getElementById("ao-action-message-close"),addModal:document.getElementById("ao-add-modal"),addClose:document.getElementById("ao-add-close"),addTabs:document.querySelectorAll(".add-tab"),addPanels:document.querySelectorAll(".add-panel"),oauthStart:document.getElementById("ao-oauth-start"),oauthContinue:document.getElementById("ao-oauth-continue"),oauthLink:document.getElementById("ao-oauth-link"),oauthCopy:document.getElementById("ao-oauth-copy"),tokenInput:document.getElementById("ao-token-input"),tokenImport:document.getElementById("ao-token-import"),importLocal:document.getElementById("ao-import-local"),importTools:document.getElementById("ao-import-tools"),addFeedback:document.getElementById("ao-add-feedback"),confirmModal:document.getElementById("ao-confirm-modal"),confirmTitle:document.getElementById("ao-confirm-title"),confirmMessage:document.getElementById("ao-confirm-message"),confirmOk:document.getElementById("ao-confirm-ok"),confirmCancel:document.getElementById("ao-confirm-cancel"),confirmClose:document.getElementById("ao-confirm-close"),quotaModal:document.getElementById("ao-quota-modal"),quotaList:document.getElementById("ao-quota-list"),quotaClose:document.getElementById("ao-quota-close"),quotaCloseBtn:document.getElementById("ao-quota-close-btn"),quotaRefresh:document.getElementById("ao-quota-refresh"),quotaBadges:document.getElementById("ao-quota-badges"),toast:document.getElementById("toast")},W="idle",F="",E="",ie=!1,$=!1,O=null,N=null;function d(e,t){return oe[e]||t}function g(e,t){return ke[e]||t}function c(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function we(e){return e?new Date(e).toLocaleString(void 0,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}function ce(e){return e>=70?"high":e>=30?"medium":"low"}function x(e){let t=(e.tier||"").trim();if(!t)return"";let o=t.toUpperCase();return o==="UNKNOWN"||o==="N/A"?"":o.includes("ULTRA")?"ULTRA":o.includes("PRO")||o.includes("PREMIUM")?"PRO":o.includes("FREE")?"FREE":o}function J(e){return e.toLowerCase()}function Ce(e){if(!e.groups||e.groups.length===0)return[];let t=new Map;return e.groups.forEach(o=>{(o.models||[]).forEach(a=>{let s=a.modelId||a.label;!t.has(s)&&typeof a.percentage=="number"&&t.set(s,a.percentage)})}),Array.from(t.values())}function U(e){let t=Ce(e);if(t.length>0){let s=t.reduce((i,r)=>i+r,0);return Math.round(s/t.length)}if(!e.groups||e.groups.length===0)return 0;let o=e.groups.map(s=>s.percentage).filter(s=>typeof s=="number");if(o.length===0)return 0;let a=o.reduce((s,i)=>s+i,0);return Math.round(a/o.length)}function de(e,t){if(!e.groups)return 0;let o=e.groups.find(a=>a.groupId===t);return!o||typeof o.percentage!="number"?0:o.percentage}function Te(e){if(!e.groups||e.groups.length===0)return[];let t=[...e.groups],o=Array.isArray(y.groupOrder)?y.groupOrder:[];if(o.length>0){let a=new Map(o.map((s,i)=>[s,i]));t.sort((s,i)=>{let r=a.has(s.groupId)?a.get(s.groupId):99999,u=a.has(i.groupId)?a.get(i.groupId):99999;return r!==u?r-u:s.groupName.localeCompare(i.groupName)})}else t.sort((a,s)=>a.groupName.localeCompare(s.groupName));return t.slice(0,4)}function K(e){h=e,h==="list"?(n.viewListBtn.classList.add("active"),n.viewGridBtn.classList.remove("active")):(n.viewGridBtn.classList.add("active"),n.viewListBtn.classList.remove("active")),l.setState({viewMode:h}),L()}function Se(e,t){!n.actionMessage||!n.actionMessageText||(n.actionMessage.className=`action-message${t?` ${t}`:""}`,n.actionMessageText.textContent=e,n.actionMessage.classList.remove("hidden"),Q&&clearTimeout(Q),Q=setTimeout(()=>{n.actionMessage.classList.add("hidden")},4e3))}function qe(){n.actionMessage&&n.actionMessage.classList.add("hidden")}function xe(e){if(!n.refreshAllBtn)return;n.refreshAllBtn.classList.add("loading"),n.refreshAllBtn.disabled=!0,n.refreshAllBtn.setAttribute("aria-disabled","true");let t=e;n.refreshAllBtn.textContent=`${t}s`,q&&clearInterval(q),q=setInterval(()=>{t-=1,t<=0?(clearInterval(q),q=null,n.refreshAllBtn.classList.remove("loading"),n.refreshAllBtn.disabled=!1,n.refreshAllBtn.removeAttribute("aria-disabled"),n.refreshAllBtn.textContent=D||d("refreshAll","Refresh")):n.refreshAllBtn.textContent=`${t}s`},1e3)}function Re(){let e=new Map;p.forEach(o=>{(o.groups||[]).forEach(a=>{a.groupId&&a.groupName&&e.set(a.groupId,a.groupName)})}),_=Array.from(e.entries()).map(([o,a])=>({id:o,name:a})).sort((o,a)=>o.name.localeCompare(a.name));let t=n.sortSelect.value;n.sortSelect.innerHTML=`<option value="overall">${c(d("sortOverall","Overall"))}</option>`,_.forEach(o=>{let a=t===o.id?"selected":"";n.sortSelect.innerHTML+=`<option value="${c(o.id)}" ${a}>${c(o.name)}</option>`}),n.sortDirectionBtn&&(n.sortDirectionBtn.textContent=S==="asc"?"\u2B06":"\u2B07",n.sortDirectionBtn.title=S==="asc"?d("sortAsc","Ascending"):d("sortDesc","Descending"))}function De(){let e={all:p.length,PRO:0,ULTRA:0};p.forEach(a=>{let s=x(a);s==="PRO"?e.PRO+=1:s==="ULTRA"&&(e.ULTRA+=1)});let t=e.PRO>0||e.ULTRA>0,o=n.filterSelect?.parentElement;if(!t){o&&o.classList.add("hidden"),C="all";return}o&&o.classList.remove("hidden"),n.filterSelect.innerHTML=`
            <option value="all">${d("filterAll","All ({count})").replace("{count}",e.all)}</option>
            <option value="PRO">${d("filterPro","PRO ({count})").replace("{count}",e.PRO)}</option>
            <option value="ULTRA">${d("filterUltra","ULTRA ({count})").replace("{count}",e.ULTRA)}</option>
        `,n.filterSelect.value=C}function re(){let e=[...p];if(H.trim()){let o=H.toLowerCase();e=e.filter(a=>a.email.toLowerCase().includes(o))}C!=="all"&&(e=e.filter(o=>x(o)===C));let t=S==="asc"?-1:1;return T!=="overall"&&_.some(o=>o.id===T)?e.sort((o,a)=>{let s=de(o,T),i=de(a,T);return s!==i?(i-s)*t:(U(a)-U(o))*t}):e.sort((o,a)=>(U(a)-U(o))*t),e}function le(e){if(e.loading)return`<div class="quota-empty">${c(d("loading","Loading..."))}</div>`;if(e.error)return`<div class="quota-empty quota-error">\u26A0\uFE0F ${c(e.error)}</div>`;let t=Te(e);return t.length===0?`<div class="quota-empty">${c(d("noQuotaData","No quota data"))}</div>`:t.map(o=>{let a=Math.round(o.percentage||0),s=ce(a);return`
                <div class="quota-compact-item">
                    <div class="quota-compact-header">
                        <span class="model-label">${c(o.groupName)}</span>
                        <span class="model-pct ${s}">${a}%</span>
                    </div>
                    <div class="quota-compact-bar-track">
                        <div class="quota-compact-bar ${s}" style="width: ${Math.min(100,a)}%"></div>
                    </div>
                    ${o.resetTimeFormatted?`<span class="quota-compact-reset">${c(o.resetTimeFormatted)}</span>`:""}
                </div>
            `}).join("")}function ue(e){let t=x(e),o=J(t),a=t?`<span class="tier-badge ${o}">${t}</span>`:"",s=e.isCurrent,i=m.has(e.email),r=e.hasDeviceBound?`${d("bound","Bound")}`:`${d("unbound","Unbound")}`,u=e.hasDeviceBound?"bound":"unbound";return`
            <div class="account-card ${s?"current":""} ${i?"selected":""}" data-email="${c(e.email)}">
                <div class="card-top">
                    <div class="card-select">
                        <input type="checkbox" data-action="select" ${i?"checked":""} data-email="${c(e.email)}" />
                    </div>
                    <span class="account-email" title="${c(e.email)}">${c(e.email)}</span>
                    ${s?`<span class="current-tag">${c(d("current","Current"))}</span>`:""}
                    ${a}
                </div>

                <div class="card-quota-grid">
                    ${le(e)}
                </div>

                <div class="card-footer">
                    <div class="card-meta">
                        <span class="card-date">${c(we(e.lastUpdated))}</span>
                        <span class="fingerprint-pill ${u}">${c(d("fingerprint","Fingerprint"))}: ${r}</span>
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn" data-action="details" data-email="${c(e.email)}" title="${c(d("details","Details"))}">\u2139\uFE0F</button>
                        ${s?"":`<button class="card-action-btn success" data-action="switch" data-email="${c(e.email)}" title="${c(d("switch","Switch"))}">\u25B6</button>`}
                        <button class="card-action-btn" data-action="refresh" data-email="${c(e.email)}" title="${c(d("refresh","Refresh"))}">\u27F3</button>
                        <button class="card-action-btn export-btn" data-action="export" data-email="${c(e.email)}" title="${c(d("export","Export"))}">\u2934</button>
                        <button class="card-action-btn danger" data-action="delete" data-email="${c(e.email)}" title="${c(d("delete","Delete"))}">\u{1F5D1}</button>
                    </div>
                </div>
            </div>
        `}function me(e){let t=x(e),o=J(t),a=t?`<span class="tier-badge ${o}">${t}</span>`:"",s=e.isCurrent,i=m.has(e.email),r=e.hasDeviceBound?`${d("bound","Bound")}`:`${d("unbound","Unbound")}`,u=e.hasDeviceBound?"bound":"unbound",b=e.loading?`<span class="quota-empty">${c(d("loading","Loading..."))}</span>`:e.error?`<span class="quota-empty quota-error">\u26A0\uFE0F ${c(e.error)}</span>`:le(e);return`
            <tr class="${s?"current":""}" data-email="${c(e.email)}">
                <td>
                    <input type="checkbox" data-action="select" ${i?"checked":""} data-email="${c(e.email)}" />
                </td>
                <td>
                    <div class="account-cell">
                        <div class="account-main-line">
                            <span class="account-email-text" title="${c(e.email)}">${c(e.email)}</span>
                            ${s?`<span class="mini-tag current">${c(d("current","Current"))}</span>`:""}
                        </div>
                        <div class="account-sub-line">
                            ${a}
                        </div>
                    </div>
                </td>
                <td>
                    <span class="fingerprint-status ${u}">${c(d("fingerprint","Fingerprint"))}: ${r}</span>
                </td>
                <td>
                    <div class="quota-grid">
                        ${b}
                    </div>
                </td>
                <td class="sticky-action-cell table-action-cell">
                    <div class="action-buttons">
                        <button class="action-btn" data-action="details" data-email="${c(e.email)}" title="${c(d("details","Details"))}">\u2139\uFE0F</button>
                        ${s?"":`<button class="action-btn success" data-action="switch" data-email="${c(e.email)}" title="${c(d("switch","Switch"))}">\u25B6</button>`}
                        <button class="action-btn" data-action="refresh" data-email="${c(e.email)}" title="${c(d("refresh","Refresh"))}">\u27F3</button>
                        <button class="action-btn danger" data-action="delete" data-email="${c(e.email)}" title="${c(d("delete","Delete"))}">\u{1F5D1}</button>
                    </div>
                </td>
            </tr>
        `}function Fe(e){return window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(e):e.replace(/["\\]/g,"\\$&")}function Oe(e){return e.map(t=>t.email)}function Ne(e){if(e.length!==j.length)return!1;for(let t=0;t<e.length;t+=1)if(e[t]!==j[t])return!1;return!0}function Ue(e,t,o){for(let a of t){let s=`[data-email="${Fe(a.email)}"]`,i=e.querySelector(s);if(!i)return!1;i.outerHTML=o(a)}return!0}function L(){if(V+=1,Re(),De(),n.currentAccount){let i=p.find(r=>r.isCurrent);i?(n.currentAccount.textContent=`${d("current","Current")} ${i.email}`,n.currentAccount.title=i.email,n.currentAccount.classList.remove("hidden")):n.currentAccount.classList.add("hidden")}if(n.totalAccounts&&(n.totalAccounts.textContent=d("totalAccounts","{count} Accounts").replace("{count}",p.length)),z){n.loading.classList.remove("hidden"),n.emptyState.classList.add("hidden"),n.emptyMatch.classList.add("hidden"),n.accountsGrid.classList.add("hidden"),n.accountsTable.classList.add("hidden");return}let e=re();if(n.loading.classList.add("hidden"),n.emptyState.classList.add("hidden"),n.emptyMatch.classList.add("hidden"),p.length===0){n.emptyState.classList.remove("hidden");return}if(e.length===0){n.emptyMatch.classList.remove("hidden");return}let t=Oe(e),o=h===se&&Ne(t),a=()=>{let i=e.map(u=>u.email),r=i.length>0&&i.every(u=>m.has(u));if(n.selectAll&&(n.selectAll.checked=r),n.deleteSelectedBtn&&(m.size>0?(n.deleteSelectedBtn.classList.remove("hidden"),n.deleteSelectedBtn.title=`${d("delete","Delete")} (${m.size})`,n.deleteSelectedBtn.setAttribute("aria-label",`${d("delete","Delete")} (${m.size})`)):n.deleteSelectedBtn.classList.add("hidden")),n.exportBtn){let u=m.size>0?`${d("export","Export")} (${m.size})`:d("export","Export");n.exportBtn.title=u,n.exportBtn.setAttribute("aria-label",u)}};if(o){let i=h==="list"?n.accountsTbody:n.accountsGrid;if(Ue(i,e,h==="list"?me:ue)){a();return}}n.accountsGrid.classList.add("hidden"),n.accountsTable.classList.add("hidden");let s=(i,r,u)=>{let b=V,B=0;i.innerHTML="";let R=()=>{if(b!==V)return;let A="",f=0;for(;B<r.length&&f<$e;)A+=u(r[B]),B+=1,f+=1;A&&i.insertAdjacentHTML("beforeend",A),B<r.length?requestAnimationFrame(R):a()};requestAnimationFrame(R)};h==="list"?(n.accountsTable.classList.remove("hidden"),s(n.accountsTbody,e,me)):(n.accountsGrid.classList.remove("hidden"),s(n.accountsGrid,e,ue)),j=t,se=h}function I(e,t){if(W=e,F=t||"",!!n.addFeedback){if(!F){n.addFeedback.classList.add("hidden");return}n.addFeedback.className=`add-feedback ${W}`,n.addFeedback.textContent=F,n.addFeedback.classList.remove("hidden")}}function X(){W="idle",F="",I("idle",""),ie=!1}function Y(e){if(!n.addModal)return;n.addModal.classList.remove("hidden");let t=e||"oauth";fe(t),X(),t==="oauth"&&ge()}function Z(){n.addModal&&(n.addModal.classList.add("hidden"),X(),pe())}function fe(e){n.addTabs.forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),n.addPanels.forEach(t=>{t.classList.toggle("hidden",t.dataset.panel!==e)}),e==="oauth"?ge():pe()}function ee(e){E=e||"",$=!1,n.oauthLink&&(n.oauthLink.value=E||d("oauthGenerating","Generating link...")),n.oauthCopy&&(n.oauthCopy.disabled=!E),n.oauthContinue&&(n.oauthContinue.disabled=!E)}function ge(){$||E||($=!0,l.postMessage({command:"addAccount",mode:"prepare"}))}function pe(){(E||$)&&l.postMessage({command:"addAccount",mode:"cancel"}),$=!1,ee("")}function he(e,t,o){n.confirmModal&&(n.confirmTitle.textContent=e,n.confirmMessage.textContent=t,O=o,n.confirmModal.classList.remove("hidden"))}function P(){n.confirmModal&&(n.confirmModal.classList.add("hidden"),O=null)}function Pe(e){N=e,n.quotaModal&&(Ge(e),n.quotaModal.classList.remove("hidden"))}function te(){n.quotaModal&&(n.quotaModal.classList.add("hidden"),N=null)}function Ge(e){let t=p.find(a=>a.email===e);if(!t||!n.quotaList)return;if(n.quotaBadges){let a=x(t),s=J(a);n.quotaBadges.innerHTML=a?`<span class="pill ${s}">${a}</span>`:""}if(t.loading){n.quotaList.innerHTML=`<div class="quota-empty">${c(d("loading","Loading..."))}</div>`;return}if(t.error){n.quotaList.innerHTML=`<div class="quota-empty quota-error">\u26A0\uFE0F ${c(t.error)}</div>`;return}let o=[];if((t.groups||[]).forEach(a=>{(a.models||[]).forEach(s=>{o.push({label:s.label||a.groupName,percentage:s.percentage||0,resetTime:s.resetTimeFormatted||s.resetTime||""})})}),o.length===0){n.quotaList.innerHTML=`<div class="quota-empty">${c(d("noQuotaData","No quota data"))}</div>`;return}n.quotaList.innerHTML=o.map(a=>{let s=Math.round(a.percentage||0),i=ce(s);return`
                <div class="quota-card">
                    <h4>${c(a.label)}</h4>
                    <div class="quota-value-row">
                        <span class="quota-value ${i}">${s}%</span>
                    </div>
                    <div class="quota-bar">
                        <div class="quota-fill ${i}" style="width: ${Math.min(100,s)}%"></div>
                    </div>
                    ${a.resetTime?`<div class="quota-reset-info">${c(a.resetTime)}</div>`:""}
                </div>
            `}).join("")}function He(){n.backBtn?.addEventListener("click",()=>{l.postMessage({command:"back"})}),n.searchInput?.addEventListener("input",e=>{H=e.target.value,L()}),n.filterSelect?.addEventListener("change",e=>{C=e.target.value,L()}),n.sortSelect?.addEventListener("change",e=>{T=e.target.value,L()}),n.sortDirectionBtn?.addEventListener("click",()=>{S=S==="asc"?"desc":"asc",L()}),n.viewListBtn?.addEventListener("click",()=>K("list")),n.viewGridBtn?.addEventListener("click",()=>K("grid")),n.refreshAllBtn?.addEventListener("click",()=>{n.refreshAllBtn.disabled||(xe(Me),l.postMessage({command:"executeCommand",commandId:"agCockpit.accountTree.refresh"}))}),n.addBtn?.addEventListener("click",()=>Y("oauth")),n.importBtn?.addEventListener("click",()=>Y("import")),n.addFirstBtn?.addEventListener("click",()=>Y("oauth")),n.exportBtn?.addEventListener("click",()=>{let e=m.size>0?Array.from(m):p.map(t=>t.email);l.postMessage({command:"exportAccounts",emails:e})}),n.deleteSelectedBtn?.addEventListener("click",()=>{if(m.size===0)return;let e=d("confirmDeleteBatch","Confirm delete {count} selected accounts?").replace("{count}",m.size);he(d("delete","Delete"),e,()=>{l.postMessage({command:"deleteAccounts",emails:Array.from(m)}),m.clear(),L()})}),n.selectAll?.addEventListener("change",e=>{let t=e.target.checked,o=re();t?o.forEach(a=>m.add(a.email)):o.forEach(a=>m.delete(a.email)),L()}),n.accountsGrid?.addEventListener("click",ve),n.accountsTbody?.addEventListener("click",ve),n.actionMessageClose?.addEventListener("click",qe),n.addClose?.addEventListener("click",Z),n.addModal?.addEventListener("click",e=>{e.target===n.addModal&&Z()}),n.addTabs?.forEach(e=>{e.addEventListener("click",()=>{fe(e.dataset.tab),X()})}),n.oauthStart?.addEventListener("click",()=>{I("loading",d("oauthStarting","Authorizing...")),l.postMessage({command:"addAccount",mode:"start"})}),n.oauthContinue?.addEventListener("click",()=>{I("loading",d("oauthContinuing","Waiting for authorization...")),l.postMessage({command:"addAccount",mode:"continue"})}),n.oauthCopy?.addEventListener("click",async()=>{if(E)try{await navigator.clipboard.writeText(E),ie=!0,G(d("copySuccess","Copied"),"success")}catch{G(d("copyFailed","Copy failed"),"error")}}),n.tokenImport?.addEventListener("click",()=>{let e=n.tokenInput?.value||"";I("loading",d("tokenImportStart","Start Import")),l.postMessage({command:"importTokens",content:e})}),n.importLocal?.addEventListener("click",()=>{I("loading",d("importingLocal","Importing...")),l.postMessage({command:"importFromLocal"})}),n.importTools?.addEventListener("click",()=>{I("loading",d("importingTools","Importing...")),l.postMessage({command:"importFromTools"})}),n.confirmCancel?.addEventListener("click",P),n.confirmClose?.addEventListener("click",P),n.confirmModal?.addEventListener("click",e=>{e.target===n.confirmModal&&P()}),n.confirmOk?.addEventListener("click",()=>{O&&O(),P()}),n.quotaClose?.addEventListener("click",te),n.quotaCloseBtn?.addEventListener("click",te),n.quotaModal?.addEventListener("click",e=>{e.target===n.quotaModal&&te()}),n.quotaRefresh?.addEventListener("click",()=>{N&&l.postMessage({command:"refreshAccount",email:N})}),document.getElementById("settings-btn")?.addEventListener("click",Ke),document.getElementById("close-settings-btn")?.addEventListener("click",Xe),document.getElementById("announcement-btn")?.addEventListener("click",Ee),document.getElementById("announcement-list-close")?.addEventListener("click",Le),document.getElementById("announcement-mark-all-read")?.addEventListener("click",We),document.getElementById("announcement-popup-later")?.addEventListener("click",w),document.getElementById("announcement-popup-got-it")?.addEventListener("click",Ve),document.getElementById("announcement-popup-action")?.addEventListener("click",je)}function ve(e){let t=e.target.closest("[data-action]");if(!t)return;let o=t.dataset.action,a=t.dataset.email;switch(o){case"select":t.checked?m.add(a):m.delete(a),L();break;case"details":Pe(a);break;case"switch":l.postMessage({command:"switchAccount",email:a});break;case"refresh":l.postMessage({command:"refreshAccount",email:a});break;case"export":l.postMessage({command:"exportAccounts",emails:[a]});break;case"delete":he(d("delete","Delete"),d("confirmDelete","Confirm delete account?"),()=>{l.postMessage({command:"deleteAccount",email:a}),m.delete(a)});break;default:break}}let v={announcements:[],unreadIds:[],popupAnnouncement:null},k=null,ye=new Set;function ne(){let e=document.getElementById("announcement-badge");if(!e)return;let t=v.unreadIds.length;t>0?(e.textContent=t>9?"9+":t,e.classList.remove("hidden")):e.classList.add("hidden")}function Ee(){l.postMessage({command:"announcement.getState"});let e=document.getElementById("announcement-list-modal");e&&e.classList.remove("hidden")}function Le(){let e=document.getElementById("announcement-list-modal");e&&e.classList.add("hidden")}function _e(){let e=document.getElementById("announcement-list");if(!e)return;let t=v.announcements||[];if(t.length===0){e.innerHTML=`<div class="announcement-empty">${g("announcement.empty","No notifications")}</div>`;return}let o={feature:"\u2728",warning:"\u26A0\uFE0F",info:"\u2139\uFE0F",urgent:"\u{1F6A8}"};e.innerHTML=t.map(a=>{let s=v.unreadIds.includes(a.id),i=o[a.type]||"\u2139\uFE0F",r=ze(a.createdAt);return`
                <div class="announcement-item ${s?"unread":""}" data-id="${a.id}">
                    <span class="announcement-icon">${i}</span>
                    <div class="announcement-info">
                        <div class="announcement-title">
                            ${s?'<span class="announcement-unread-dot"></span>':""}
                            <span>${c(a.title)}</span>
                        </div>
                        <div class="announcement-summary">${c(a.summary)}</div>
                        <div class="announcement-time">${r}</div>
                    </div>
                </div>
            `}).join(""),e.querySelectorAll(".announcement-item").forEach(a=>{a.addEventListener("click",()=>{let s=a.dataset.id,i=t.find(r=>r.id===s);if(i){if(v.unreadIds.includes(s)){l.postMessage({command:"announcement.markAsRead",id:s}),v.unreadIds=v.unreadIds.filter(u=>u!==s),ne(),a.classList.remove("unread");let r=a.querySelector(".announcement-unread-dot");r&&r.remove()}be(i,!0),Le()}})})}function ze(e){let t=new Date(e),a=new Date-t,s=Math.floor(a/6e4),i=Math.floor(a/36e5),r=Math.floor(a/864e5);return s<1?g("announcement.timeAgo.justNow","Just now"):s<60?g("announcement.timeAgo.minutesAgo","{count}m ago").replace("{count}",s):i<24?g("announcement.timeAgo.hoursAgo","{count}h ago").replace("{count}",i):g("announcement.timeAgo.daysAgo","{count}d ago").replace("{count}",r)}function be(e,t=!1){k=e;let o={feature:g("announcement.type.feature","\u2728 New Feature"),warning:g("announcement.type.warning","\u26A0\uFE0F Warning"),info:g("announcement.type.info","\u2139\uFE0F Info"),urgent:g("announcement.type.urgent","\u{1F6A8} Urgent")},a=document.getElementById("announcement-popup-type"),s=document.getElementById("announcement-popup-title"),i=document.getElementById("announcement-popup-content"),r=document.getElementById("announcement-popup-action"),u=document.getElementById("announcement-popup-got-it"),b=document.getElementById("announcement-popup-back"),B=document.getElementById("announcement-popup-close");if(a&&(a.textContent=o[e.type]||o.info,a.className=`announcement-type-badge ${e.type}`),s&&(s.textContent=e.title),i){let A=`<div class="announcement-text">${c(e.content).replace(/\n/g,"<br>")}</div>`;if(e.images&&e.images.length>0){A+='<div class="announcement-images">';for(let f of e.images)A+=`
                        <div class="announcement-image-item">
                            <img src="${c(f.url)}" alt="${c(f.alt||f.label||"")}" class="announcement-image" data-preview-url="${c(f.url)}" title="${g("announcement.clickToEnlarge","Click to enlarge")}" />
                            <div class="image-skeleton"></div>
                            ${f.label?`<div class="announcement-image-label">${c(f.label)}</div>`:""}
                        </div>
                    `;A+="</div>"}i.innerHTML=A,i.querySelectorAll(".announcement-image").forEach(f=>{f.addEventListener("load",()=>{f.classList.add("loaded")}),f.addEventListener("error",()=>{let M=f.closest(".announcement-image-item");if(M){let Ae=M.querySelector(".image-skeleton");Ae&&Ae.remove(),f.style.display="none";let ae=document.createElement("div");ae.className="image-load-error",ae.innerHTML=`
                            <span class="icon">\u{1F5BC}\uFE0F</span>
                            <span>${g("announcement.imageLoadFailed","Image failed to load")}</span>
                        `,M.insertBefore(ae,M.firstChild)}}),f.addEventListener("click",()=>{let M=f.getAttribute("data-preview-url");M&&Be(M)})})}e.action&&e.action.label?(r&&(r.textContent=e.action.label,r.classList.remove("hidden")),u&&u.classList.add("hidden")):(r&&r.classList.add("hidden"),u&&u.classList.remove("hidden")),t?(b&&(b.classList.remove("hidden"),b.onclick=()=>{w(!0),Ee()}),B&&(B.onclick=()=>w(!0))):(b&&b.classList.add("hidden"),B&&(B.onclick=()=>w()));let R=document.getElementById("announcement-popup-modal");R&&R.classList.remove("hidden")}function Qe(){if(!k)return;let e=k.id;l.postMessage({command:"announcement.markAsRead",id:e}),v.unreadIds.includes(e)&&(v.unreadIds=v.unreadIds.filter(t=>t!==e),ne())}function w(e=!1){Qe();let t=document.getElementById("announcement-popup-modal"),o=t?.querySelector(".announcement-popup-content"),a=document.getElementById("announcement-btn");if(t&&o&&a&&!e){let s=a.getBoundingClientRect(),i=o.getBoundingClientRect(),r=s.left+s.width/2-(i.left+i.width/2),u=s.top+s.height/2-(i.top+i.height/2);o.style.transition="transform 0.4s ease-in, opacity 0.4s ease-in",o.style.transform=`translate(${r}px, ${u}px) scale(0.1)`,o.style.opacity="0",a.classList.add("bell-shake"),setTimeout(()=>{t.classList.add("hidden"),o.style.transition="",o.style.transform="",o.style.opacity="",a.classList.remove("bell-shake")},400)}else t&&t.classList.add("hidden");k=null}function Ve(){w()}function je(){if(k&&k.action){let e=k.action;e.type==="tab"?l.postMessage({command:"openDashboard",tab:e.target}):e.type==="url"?l.postMessage({command:"openUrl",url:e.target}):e.type==="command"&&l.postMessage({command:"executeCommand",commandId:e.target,commandArgs:e.arguments||[]})}w()}function We(){l.postMessage({command:"announcement.markAllAsRead"}),G(g("announcement.markAllRead","All marked as read"),"success")}function Je(e){v=e,ne(),_e(),e.popupAnnouncement&&!ye.has(e.popupAnnouncement.id)&&(ye.add(e.popupAnnouncement.id),setTimeout(()=>{be(e.popupAnnouncement)},600))}function Be(e){let t=document.createElement("div");t.className="image-preview-overlay",t.innerHTML=`
            <div class="image-preview-container">
                <img src="${e}" class="image-preview-img" />
                <div class="image-preview-hint">${g("announcement.clickToClose","Click to close")}</div>
            </div>
        `,t.addEventListener("click",()=>{t.classList.add("closing"),setTimeout(()=>t.remove(),200)}),document.body.appendChild(t),requestAnimationFrame(()=>t.classList.add("visible"))}window.showImagePreview=Be;function Ke(){let e=document.getElementById("settings-modal");if(!e)return;let t=document.getElementById("notification-enabled"),o=document.getElementById("warning-threshold"),a=document.getElementById("critical-threshold");t&&(t.checked=y.notificationEnabled!==!1),o&&(o.value=y.warningThreshold||30),a&&(a.value=y.criticalThreshold||10);let s=document.getElementById("display-mode-select");if(s){let i=y.displayMode||"webview";s.value=i,s.onchange=()=>{s.value==="quickpick"&&l.postMessage({command:"updateDisplayMode",displayMode:"quickpick"})}}Ze(),Ye(),et(),e.classList.remove("hidden")}function Xe(){let e=document.getElementById("settings-modal");e&&e.classList.add("hidden")}function Ye(){let e=document.getElementById("statusbar-format");if(!e)return;let t=y.statusBarFormat||"standard";e.value=t,e.onchange=null,e.addEventListener("change",()=>{let o=e.value;l.postMessage({command:"updateStatusBarFormat",statusBarFormat:o})})}function Ze(){let e=document.getElementById("language-select");if(!e)return;let t=y.language||"auto";e.value=t,e.onchange=null,e.addEventListener("change",()=>{let o=e.value;l.postMessage({command:"updateLanguage",language:o}),G(g("language.changed","Language changed. Reopen panel to apply."),"info")})}function et(){let e=document.getElementById("notification-enabled"),t=document.getElementById("warning-threshold"),o=document.getElementById("critical-threshold");e&&(e.onchange=null,e.addEventListener("change",()=>{l.postMessage({command:"updateNotificationEnabled",notificationEnabled:e.checked})})),t&&(t.onblur=null,t.addEventListener("blur",Ie)),o&&(o.onblur=null,o.addEventListener("blur",Ie))}function Ie(){let e=document.getElementById("warning-threshold"),t=document.getElementById("critical-threshold"),o=parseInt(e?.value,10)||30,a=parseInt(t?.value,10)||10;o<5&&(o=5),o>80&&(o=80),a<1&&(a=1),a>50&&(a=50),a>=o&&(a=o-1,a<1&&(a=1)),e&&(e.value=o),t&&(t.value=a),tt()}function tt(){let e=document.getElementById("notification-enabled"),t=document.getElementById("warning-threshold"),o=document.getElementById("critical-threshold"),a=e?.checked??!0,s=parseInt(t?.value,10)||30,i=parseInt(o?.value,10)||10;l.postMessage({command:"updateThresholds",notificationEnabled:a,warningThreshold:s,criticalThreshold:i})}function G(e,t="info"){n.toast&&(n.toast.textContent=e,n.toast.className=`toast ${t}`,setTimeout(()=>{n.toast.classList.add("hidden")},3e3))}function nt(e){let t=e.data;switch(t.type){case"accountsUpdate":p=t.data.accounts||[],t.data.i18n&&Object.assign(oe,t.data.i18n),t.data.config&&(y=t.data.config),D=d("refreshAll","Refresh"),n.refreshAllBtn&&!n.refreshAllBtn.disabled&&(n.refreshAllBtn.textContent=D),z&&(z=!1),m=new Set(Array.from(m).filter(o=>p.some(a=>a.email===o))),L();break;case"announcementState":Je(t.data);break;case"actionResult":at(t.data);break;case"actionProgress":ot(t.data);break;case"oauthUrl":ee(t.data.url||"");break;default:break}}function at(e){let t=e.status||"success",o=e.message||"";if((e.context||"")==="add"){$=!1,I(t,o),t==="success"&&e.closeModal&&setTimeout(()=>Z(),1200);return}o&&Se(o,t==="error"?"error":"success")}function ot(e){let t=e.message||"";e.context==="add"&&I("loading",t)}function st(){let e=l.getState();e?.viewMode&&(h=e.viewMode),D=d("refreshAll","Refresh"),K(h),ee(E),He(),window.addEventListener("message",nt),l.postMessage({command:"ready"})}st()})();})();
